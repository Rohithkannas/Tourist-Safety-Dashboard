<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login • Tourist Safety Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { bgdark: '#000000' } } } };
  </script>
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <style>
    body { background: radial-gradient(100% 100% at 0% 0%, rgba(255,255,255,0.06), rgba(0,0,0,0) 45%),
                      radial-gradient(70% 100% at 100% 0%, rgba(255,255,255,0.03), rgba(0,0,0,0) 40%),
                      #000; }
    .glass { backdrop-filter: blur(12px); background: rgba(0, 0, 0, 0.45); border: 1px solid rgba(255,255,255,0.08); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center text-white">
  <a href="./index.html" class="absolute top-6 left-6 text-white/70 hover:text-white">← Back</a>
  <div class="w-full max-w-md p-8 rounded-2xl glass">
    <div class="mb-6">
      <h1 class="text-2xl font-bold">Authority Login</h1>
      <p class="text-white/70 text-sm">Use your email and password to access the dashboard.</p>
    </div>

    <form id="loginForm" class="space-y-5 text-base">
      <div>
        <label class="block text-sm mb-1">Email</label>
        <input id="email" type="email" required class="w-full px-3 py-3 rounded-md bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white" placeholder="name@agency.gov" />
      </div>
      <div>
        <label class="block text-sm mb-1">Password</label>
        <input id="password" type="password" required class="w-full px-3 py-3 rounded-md bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white" placeholder="••••••••" />
      </div>
      <div>
        <label class="block text-sm mb-1">Role</label>
        <select id="role" class="w-full px-3 py-3 rounded-md border border-white/10 focus:outline-none focus:ring-2 focus:ring-white">
          <option>Police</option>
          <option>Tourism Dept.</option>
          <option>State Admin</option>
          <option>NIC/Govt.</option>
        </select>
      </div>
      <button class="btn w-full py-3 text-base" type="submit">Login</button>
      <div class="flex gap-3">
        <button id="demoBtn" class="btn-outline px-4 py-2 rounded-md" type="button">Demo</button>
        <button id="resetBtn" type="button" class="btn-outline px-4 py-2 rounded-md">Forgot password</button>
      </div>
      <p id="error" class="text-red-400 text-sm hidden"></p>
    </form>
  </div>

  <!-- Firebase (optional for MVP) v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="./assets/js/firebase-config.js"></script>
  <script>
    const form = document.getElementById('loginForm');
    const err = document.getElementById('error');
    const demoBtn = document.getElementById('demoBtn');
    const resetBtn = document.getElementById('resetBtn');

    function redirect() { window.location.href = './language.html'; }
    function saveRole(){ const r = document.getElementById('role')?.value || 'Police'; localStorage.setItem('role', r); }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.classList.add('hidden');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        if (window.firebase && window.firebase.apps && window.firebase.apps.length) {
          const auth = firebase.auth();
          const cred = await auth.signInWithEmailAndPassword(email, password);
          localStorage.setItem('demoAuth', 'firebase');
          localStorage.setItem('apiToken', 'dev-key');
          saveRole();
          // Save login metadata to Firestore if configured
          try {
            if (firebase.firestore) {
              const db = firebase.firestore();
              await db.collection('users').doc(cred.user.uid).set({
                email,
                role: localStorage.getItem('role') || 'Police',
                lastLogin: new Date().toISOString()
              }, { merge: true });
            }
          } catch(_) {}
          redirect();
        } else {
          throw new Error('Firebase not configured. Use demo mode or add config.');
        }
      } catch (e) {
        err.textContent = e.message;
        err.classList.remove('hidden');
      }
    });

    demoBtn.addEventListener('click', () => {
      localStorage.setItem('demoAuth', 'demo');
      localStorage.setItem('apiToken', 'dev-key');
      saveRole();
      redirect();
    });

    resetBtn.addEventListener('click', async ()=>{
      try {
        const email = document.getElementById('email').value.trim();
        if (!email) throw new Error('Enter email to reset');
        if (window.firebase && firebase.apps && firebase.apps.length) {
          await firebase.auth().sendPasswordResetEmail(email);
          alert('Reset email sent. Check your inbox.');
        } else { throw new Error('Firebase not configured'); }
      } catch (e) { err.textContent = e.message; err.classList.remove('hidden'); }
    });
  </script>
</body>
</html>
